<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDEM Training Events</title>
    <style>
        /* 2006-2008 business app vibe: muted, compact */
        :root {
            --bg: #ffffff;
            --fg: #111111;
            --muted: #dcdcdc;
            --muted-2: #f2f2f2;
            --accent: #2c2c2c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            background: var(--bg); 
            color: var(--fg); 
            font-family: Arial, Helvetica, sans-serif; 
            font-size: 14px; 
        }

        /* Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 1001;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Focus styles */
        a:focus,
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .app-header { 
            display: flex; 
            align-items: center; 
            padding: 8px 12px; 
            border-bottom: 1px solid var(--muted); 
            background: var(--muted-2); 
        }
        .app-header .brand { font-weight: bold; }
        .app-header .spacer { flex: 1; }
        .app-header a { color: var(--accent); text-decoration: none; margin-left: 12px; }

        .content { padding: 12px; }
        .page-title { font-size: 18px; margin: 8px 0 12px 0; text-align: left; }

        .card { 
            border: 1px solid var(--muted); 
            background: #fff; 
            margin-bottom: 12px;
        }
        .card-title { 
            background: var(--muted-2); 
            padding: 6px 8px; 
            font-weight: bold; 
            border-bottom: 1px solid var(--muted); 
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title:hover {
            background: #e8e8e8;
        }
        
        .collapse-icon {
            font-family: monospace;
            font-size: 16px;
        }
        
        .card-body {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .card-body.collapsed {
            max-height: 0;
        }

        .controls { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 8px; 
            padding: 8px;
            flex-wrap: wrap;
        }

        .table-scroll { 
            overflow: auto; 
            border: 1px solid var(--muted); 
        }
        
        .data-table { 
            width: 100%; 
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td { 
            padding: 6px 8px; 
            border-bottom: 1px solid #eee; 
            white-space: nowrap; 
            text-align: left; 
        }
        
        .data-table thead th { 
            background: var(--muted-2); 
            font-weight: bold; 
            text-align: left; 
        }
        
        .data-table tbody tr:nth-child(odd) { 
            background: #fafafa; 
        }

        /* Buttons */
        .button, button {
            display: inline-block;
            padding: 6px 12px;
            border: 1px solid var(--muted);
            background: var(--muted-2);
            color: var(--accent);
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        .button:hover, button:hover {
            background: #e8e8e8;
        }
        
        .danger { 
            border-color: #c77; 
            background: #fee; 
            color: #900; 
        }
        
        .danger:hover {
            background: #fdd;
        }

        /* Forms: grid layout */
        #edit-form {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 8px 12px;
            max-width: 900px;
            padding: 12px;
        }
        
        #edit-form .field { 
            display: contents; 
        }
        
        #edit-form label {
            justify-self: start;
            align-self: center;
            font-size: 13px;
            color: #333;
            text-align: left;
        }
        
        #edit-form .input {
            padding: 4px 6px;
            border: 1px solid var(--muted);
            width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #edit-form textarea.input { 
            min-height: 60px; 
            resize: vertical;
        }

        .required { 
            color: #900; 
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
        }

        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
            padding: 8px 12px;
            margin: 8px 12px;
            font-size: 13px;
            display: none;
        }

        .success-message.show {
            display: block;
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 8px 12px;
            margin: 8px 12px;
            font-size: 13px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: white;
            border: 1px solid var(--muted);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: var(--muted-2);
            padding: 8px 12px;
            border-bottom: 1px solid var(--muted);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-weight: bold;
            font-size: 14px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 1;
        }
        
        .modal-body {
            padding: 12px;
            overflow: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 8px 12px;
            border-top: 1px solid var(--muted);
            background: var(--muted-2);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .json-viewer {
            background: #f5f5f5;
            border: 1px solid var(--muted);
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow: auto;
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--muted);
        }
        
        .pagination button {
            padding: 4px 8px;
            min-width: 32px;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            font-size: 13px;
            color: #666;
        }

        @media (max-width: 720px) {
            #edit-form { 
                grid-template-columns: 1fr; 
            }
            #edit-form label { 
                justify-self: start; 
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="app-header">
        <div class="brand">VDEM Training Events</div>
        <div class="spacer"></div>
        <a href="#events">Events</a>
    </div>

    <div class="content" id="main-content">
        <h1 class="page-title">Training Event Management</h1>

        <div class="card">
            <div class="card-title" onclick="toggleCollapse('settings')">
                <span>Settings</span>
                <span class="collapse-icon" id="settings-icon">+</span>
            </div>
            <div class="card-body collapsed" id="settings-body">
                <div style="background: #e8f4f8; border: 1px solid #b8dce8; padding: 8px; font-size: 12px; margin-bottom: 12px;">
                    <strong>Data Storage:</strong> <span id="storage-status">Checking...</span><br>
                    <span style="font-size: 11px; color: #555;">
                        • Changes auto-save to browser storage<br>
                        • "Save to File" creates a downloadable backup<br>
                        • "Clear Browser Storage" resets to embedded data
                    </span>
                </div>
                
                <form id="settings-form">
                    <div class="field">
                        <label for="api_endpoint">API Endpoint URL</label>
                        <input type="url" id="api_endpoint" name="api_endpoint" class="input" placeholder="https://api.example.com/events">
                    </div>
                    
                    <div class="field">
                        <label for="api_key">API Key (optional)</label>
                        <input type="password" id="api_key" name="api_key" class="input" placeholder="Your API key">
                    </div>
                    
                    <div class="field">
                        <label for="request_method">Request Method</label>
                        <select id="request_method" name="request_method" class="input">
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                        </select>
                    </div>
                    
                    <div class="field">
                        <label for="cors_mode">CORS Mode</label>
                        <select id="cors_mode" name="cors_mode" class="input">
                            <option value="cors">CORS (requires server support)</option>
                            <option value="no-cors">No-CORS (fire-and-forget)</option>
                        </select>
                    </div>
                    
                    <div class="field">
                        <label></label>
                        <div style="background: #fffacd; border: 1px solid #e6d700; padding: 8px; font-size: 12px; margin-bottom: 8px;">
                            <strong>Note:</strong> No-CORS mode sends data but cannot read the response. Use when CORS is not configured on the server.
                        </div>
                    </div>
                    
                    <div class="field">
                        <label></label>
                        <button type="button" onclick="saveSettings()">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-title" onclick="toggleCollapse('add-form')">
                <span>Add New Event</span>
                <span class="collapse-icon" id="add-form-icon">−</span>
            </div>
            <div class="card-body" id="add-form-body">
                <div id="successMessage" class="success-message">Event added successfully!</div>
                
                <form id="edit-form">
                    <div class="field">
                        <label for="title">Title <span class="required">*</span></label>
                        <input type="text" id="title" name="title" class="input" maxlength="150" required>
                    </div>

                    <div class="field">
                        <label for="start_date">Start Date <span class="required">*</span></label>
                        <input type="date" id="start_date" name="start_date" class="input" required>
                    </div>

                    <div class="field">
                        <label for="end_date">End Date <span class="required">*</span></label>
                        <input type="date" id="end_date" name="end_date" class="input" required>
                    </div>

                    <div class="field">
                        <label for="start_time">Start Time</label>
                        <input type="time" id="start_time" name="start_time" class="input">
                    </div>

                    <div class="field">
                        <label for="end_time">End Time</label>
                        <input type="time" id="end_time" name="end_time" class="input">
                    </div>

                    <div class="field">
                        <label for="course_code">Course Code</label>
                        <input type="text" id="course_code" name="course_code" class="input" maxlength="15" pattern="[A-Z0-9]+" placeholder="e.g., ICS100">
                    </div>

                    <div class="field">
                        <label for="course_name">Course Name</label>
                        <input type="text" id="course_name" name="course_name" class="input" maxlength="100">
                    </div>

                    <div class="field">
                        <label for="type">Type</label>
                        <select id="type" name="type" class="input">
                            <option value="">-- Select Type --</option>
                            <option value="ICS">ICS</option>
                            <option value="G-series">G-series</option>
                            <option value="L-series">L-series</option>
                            <option value="HazMat">HazMat</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="field">
                        <label for="location_city">Location City <span class="required">*</span></label>
                        <input type="text" id="location_city" name="location_city" class="input" maxlength="50" required>
                    </div>

                    <div class="field">
                        <label for="location_state">State <span class="required">*</span></label>
                        <input type="text" id="location_state" name="location_state" class="input" maxlength="2" value="VA" pattern="[A-Z]{2}" placeholder="VA" required>
                    </div>

                    <div class="field">
                        <label for="delivery_mode">Delivery Mode</label>
                        <select id="delivery_mode" name="delivery_mode" class="input">
                            <option value="">-- Select Mode --</option>
                            <option value="In-Person">In-Person</option>
                            <option value="Virtual">Virtual</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>

                    <div class="field">
                        <label for="location_detail">Location Detail</label>
                        <input type="text" id="location_detail" name="location_detail" class="input" maxlength="150">
                    </div>

                    <div class="field">
                        <label for="application_notes">Application Notes</label>
                        <textarea id="application_notes" name="application_notes" class="input" maxlength="200"></textarea>
                    </div>

                    <div class="field">
                        <label for="admin_notes">Admin Notes</label>
                        <textarea id="admin_notes" name="admin_notes" class="input" maxlength="150"></textarea>
                    </div>

                    <div class="field">
                        <label></label>
                        <button type="submit">Add Event</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Training Events</div>
            <div id="publishMessage" class="success-message">Published successfully!</div>
            <div id="publishError" class="error-message">Publish failed. Check your settings and try again.</div>
            <div class="controls">
                <button onclick="exportData()">Export Data (JSON)</button>
                <button onclick="document.getElementById('import-file').click()">Import Data (JSON)</button>
                <button onclick="loadFromVDEM()">Load from VDEM Website</button>
                <button onclick="saveToFile()">Save to File (Download HTML)</button>
                <button onclick="publishData()">Publish to API</button>
                <button onclick="clearStorage()" class="danger">Clear Browser Storage</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <div class="spacer"></div>
                <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;">
                    <input type="checkbox" id="hide-past" onchange="filterPastEvents()" checked>
                    Hide past events
                </label>
                <span class="page-info">Total Events: <strong id="total-count">0</strong></span>
            </div>
            <div class="table-scroll">
                <table class="data-table" id="eventsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th style="cursor: pointer;" onclick="toggleSort()">
                                Start Date <span id="sort-indicator">▼</span>
                            </th>
                            <th>End Date</th>
                            <th>Course Code</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Delivery Mode</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr>
                            <td colspan="9" class="empty-state">No events added yet. Add your first event above!</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button onclick="changePage(-1)" id="prev-btn" disabled>← Previous</button>
                <span class="page-info">Page <strong id="current-page">1</strong> of <strong id="total-pages">1</strong></span>
                <button onclick="changePage(1)" id="next-btn" disabled>Next →</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Export Data (JSON)</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="json-viewer" id="jsonViewer"></div>
            </div>
            <div class="modal-footer">
                <button onclick="copyToClipboard()">Copy to Clipboard</button>
                <button onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Embedded Data -->
    <script id="embedded-data" type="application/json">
[]
    </script>

    <!-- Embedded Settings -->
    <script id="embedded-settings" type="application/json">
{
  "api_endpoint": "",
  "api_key": "",
  "request_method": "POST",
  "cors_mode": "no-cors"
}
    </script>

    <script>
        // Load events from localStorage or embedded data
        function loadEventsFromStorage() {
            const stored = localStorage.getItem('vdem_training_events');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse localStorage events:', e);
                }
            }
            // Fallback to embedded data
            return JSON.parse(document.getElementById('embedded-data').textContent.trim());
        }

        // Fetch latest data from GitHub Pages
        async function fetchLatestData() {
            const url = 'https://nathanproton.github.io/vdem-training/import-data.json';
            
            try {
                console.log('Fetching latest data from GitHub Pages...');
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch latest data');
                }
                
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    console.log(`✓ Loaded ${data.length} events from GitHub Pages`);
                    events = data;
                    nextId = events.length > 0 ? Math.max(...events.map(e => e.event_id)) + 1 : 1;
                    
                    // Save to localStorage
                    saveEventsToStorage();
                    updateStorageStatus();
                    
                    // Render
                    renderEvents();
                    
                    return true;
                }
            } catch (error) {
                console.error('Failed to fetch from GitHub Pages:', error);
                return false;
            }
        }

        // Load settings from localStorage or embedded data
        function loadSettingsFromStorage() {
            const stored = localStorage.getItem('vdem_training_settings');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse localStorage settings:', e);
                }
            }
            // Fallback to embedded data
            return JSON.parse(document.getElementById('embedded-settings').textContent.trim());
        }

        // Save events to localStorage
        function saveEventsToStorage() {
            localStorage.setItem('vdem_training_events', JSON.stringify(events));
        }

        // Save settings to localStorage
        function saveSettingsToStorage() {
            localStorage.setItem('vdem_training_settings', JSON.stringify(settings));
        }

        let events = loadEventsFromStorage();
        let nextId = events.length > 0 ? Math.max(...events.map(e => e.event_id)) + 1 : 1;

        let settings = loadSettingsFromStorage();

        // Pagination and sorting
        const ITEMS_PER_PAGE = 20;
        let currentPage = 1;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        let hidePastEvents = true;
        let editingEventId = null;

        // DOM Elements
        const eventForm = document.getElementById('edit-form');
        const eventsTableBody = document.getElementById('eventsTableBody');
        const successMessage = document.getElementById('successMessage');
        const publishMessage = document.getElementById('publishMessage');
        const publishError = document.getElementById('publishError');
        const totalCountEl = document.getElementById('total-count');
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // Update storage status display
        function updateStorageStatus() {
            const statusEl = document.getElementById('storage-status');
            const hasStoredEvents = localStorage.getItem('vdem_training_events') !== null;
            const hasStoredSettings = localStorage.getItem('vdem_training_settings') !== null;
            
            if (hasStoredEvents || hasStoredSettings) {
                statusEl.innerHTML = '✓ Using browser storage (auto-saves changes)';
                statusEl.style.color = '#060';
            } else {
                statusEl.innerHTML = 'Using embedded data (use "Save to File" to persist)';
                statusEl.style.color = '#666';
            }
        }

        // Load settings into form
        function loadSettings() {
            document.getElementById('api_endpoint').value = settings.api_endpoint || '';
            document.getElementById('api_key').value = settings.api_key || '';
            document.getElementById('request_method').value = settings.request_method || 'POST';
            document.getElementById('cors_mode').value = settings.cors_mode || 'no-cors';
            updateStorageStatus();
        }

        // Save settings
        function saveSettings() {
            settings.api_endpoint = document.getElementById('api_endpoint').value;
            settings.api_key = document.getElementById('api_key').value;
            settings.request_method = document.getElementById('request_method').value;
            settings.cors_mode = document.getElementById('cors_mode').value;
            saveSettingsToStorage();
            updateStorageStatus();
            alert('Settings saved! Changes are stored in browser. Click "Save to File" to download a backup.');
        }

        // Publish data to external API
        async function publishData() {
            if (!settings.api_endpoint) {
                alert('Please configure your API endpoint in Settings first.');
                toggleCollapse('settings');
                return;
            }

            // Hide previous messages
            publishMessage.classList.remove('show');
            publishError.classList.remove('show');

            const method = settings.request_method || 'POST';
            const corsMode = settings.cors_mode || 'no-cors';

            try {
                const headers = {};
                let body;

                // In no-cors mode, we can only use simple headers
                if (corsMode === 'no-cors') {
                    // Use application/x-www-form-urlencoded for simple request
                    headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    // Convert events to URL-encoded format
                    body = 'data=' + encodeURIComponent(JSON.stringify(events));
                } else {
                    // CORS mode - can use JSON
                    headers['Content-Type'] = 'application/json';
                    body = JSON.stringify(events);
                    
                    // Add API key only in CORS mode (not allowed in no-cors)
                    if (settings.api_key) {
                        headers['Authorization'] = `Bearer ${settings.api_key}`;
                    }
                }

                const fetchOptions = {
                    method: method,
                    headers: headers,
                    body: body
                };

                // Add mode if no-cors
                if (corsMode === 'no-cors') {
                    fetchOptions.mode = 'no-cors';
                }

                const response = await fetch(settings.api_endpoint, fetchOptions);

                // In no-cors mode, we can't read the response
                if (corsMode === 'no-cors') {
                    publishMessage.textContent = 'Data sent successfully (no-cors mode - response cannot be verified)';
                    publishMessage.classList.add('show');
                    setTimeout(() => {
                        publishMessage.classList.remove('show');
                        publishMessage.textContent = 'Published successfully!';
                    }, 4000);
                } else {
                    // CORS mode - check response
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    publishMessage.textContent = 'Published successfully!';
                    publishMessage.classList.add('show');
                    setTimeout(() => {
                        publishMessage.classList.remove('show');
                    }, 3000);
                }

            } catch (error) {
                console.error('Publish failed:', error);
                publishError.textContent = `Publish failed: ${error.message}`;
                publishError.classList.add('show');
                setTimeout(() => {
                    publishError.classList.remove('show');
                }, 5000);
            }
        }

        // Toggle collapse
        function toggleCollapse(id) {
            const body = document.getElementById(id + '-body');
            const icon = document.getElementById(id + '-icon');
            body.classList.toggle('collapsed');
            icon.textContent = body.classList.contains('collapsed') ? '+' : '−';
        }

        // Toggle sort direction
        function toggleSort() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            document.getElementById('sort-indicator').textContent = sortDirection === 'asc' ? '▲' : '▼';
            currentPage = 1; // Reset to first page
            renderEvents();
        }

        // Filter past events
        function filterPastEvents() {
            hidePastEvents = document.getElementById('hide-past').checked;
            currentPage = 1; // Reset to first page
            renderEvents();
        }

        // Get filtered and sorted events
        function getFilteredEvents() {
            let filteredEvents = [...events];
            
            // Filter past events if checkbox is checked
            if (hidePastEvents) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.end_date);
                    return eventDate >= today;
                });
            }
            
            // Sort by start date
            filteredEvents.sort((a, b) => {
                const dateA = new Date(a.start_date);
                const dateB = new Date(b.start_date);
                return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            return filteredEvents;
        }

        // Pagination functions
        function getTotalPages() {
            const filtered = getFilteredEvents();
            return Math.ceil(filtered.length / ITEMS_PER_PAGE) || 1;
        }

        function getPaginatedEvents() {
            const filtered = getFilteredEvents();
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            return filtered.slice(start, end);
        }

        function updatePaginationControls() {
            const totalPages = getTotalPages();
            const filtered = getFilteredEvents();
            totalCountEl.textContent = filtered.length + (hidePastEvents ? ' (upcoming)' : ' (all)');
            currentPageEl.textContent = currentPage;
            totalPagesEl.textContent = totalPages;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage >= totalPages || filtered.length === 0;
        }

        function changePage(delta) {
            const totalPages = getTotalPages();
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderEvents();
            }
        }

        // Render events table
        function renderEvents() {
            const filtered = getFilteredEvents();
            
            if (filtered.length === 0) {
                const message = hidePastEvents ? 'No upcoming events. Uncheck "Hide past events" to see all events.' : 'No events added yet. Add your first event above!';
                eventsTableBody.innerHTML = '<tr><td colspan="9" class="empty-state">' + message + '</td></tr>';
                updatePaginationControls();
                return;
            }

            const paginatedEvents = getPaginatedEvents();
            
            eventsTableBody.innerHTML = paginatedEvents.map(event => `
                <tr>
                    <td>${event.event_id}</td>
                    <td>${event.title}</td>
                    <td>${event.start_date}${event.start_time ? ' ' + event.start_time : ''}</td>
                    <td>${event.end_date}${event.end_time ? ' ' + event.end_time : ''}</td>
                    <td>${event.course_code || '-'}</td>
                    <td>${event.type || '-'}</td>
                    <td>${event.location_city}, ${event.location_state}</td>
                    <td>${event.delivery_mode || '-'}</td>
                    <td>
                        <button onclick="editEvent(${event.event_id})" style="margin-right: 4px;">Edit</button>
                        <button class="danger" onclick="deleteEvent(${event.event_id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            updatePaginationControls();
        }

        // Edit event
        function editEvent(id) {
            const event = events.find(e => e.event_id === id);
            if (!event) return;

            // Store editing ID
            editingEventId = id;

            // Populate form
            document.getElementById('title').value = event.title || '';
            document.getElementById('start_date').value = event.start_date || '';
            document.getElementById('end_date').value = event.end_date || '';
            document.getElementById('start_time').value = event.start_time || '';
            document.getElementById('end_time').value = event.end_time || '';
            document.getElementById('course_code').value = event.course_code || '';
            document.getElementById('course_name').value = event.course_name || '';
            document.getElementById('type').value = event.type || '';
            document.getElementById('location_city').value = event.location_city || '';
            document.getElementById('location_state').value = event.location_state || '';
            document.getElementById('delivery_mode').value = event.delivery_mode || '';
            document.getElementById('location_detail').value = event.location_detail || '';
            document.getElementById('application_notes').value = event.application_notes || '';
            document.getElementById('admin_notes').value = event.admin_notes || '';

            // Show form if collapsed
            const formBody = document.getElementById('add-form-body');
            if (formBody.classList.contains('collapsed')) {
                toggleCollapse('add-form');
            }

            // Scroll to form
            document.getElementById('add-form-body').scrollIntoView({ behavior: 'smooth' });

            // Change button text
            const submitBtn = eventForm.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Event';
        }

        // Add/Update event
        eventForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(eventForm);
            
            let event;
            if (editingEventId !== null) {
                // Update existing event
                event = events.find(e => e.event_id === editingEventId);
                if (!event) {
                    alert('Event not found!');
                    return;
                }
                event.updated_at = new Date().toISOString();
            } else {
                // Create new event
                event = {
                    event_id: nextId++,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
            }

            // Collect form data
            for (let [key, value] of formData.entries()) {
                event[key] = value || null;
            }

            // Validation
            if (new Date(event.start_date) > new Date(event.end_date)) {
                alert('Start date must be before or equal to end date');
                return;
            }

            if (event.start_time && event.end_time && event.start_time >= event.end_time) {
                alert('Start time must be before end time');
                return;
            }

            // Add event if new
            if (editingEventId === null) {
                events.push(event);
            }
            
            // Save to localStorage
            saveEventsToStorage();
            updateStorageStatus();

            // Show success message
            successMessage.textContent = editingEventId !== null ? 'Event updated successfully!' : 'Event added successfully!';
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
                successMessage.textContent = 'Event added successfully!';
            }, 3000);

            // Reset form
            eventForm.reset();
            document.getElementById('location_state').value = 'VA';
            editingEventId = null;

            // Reset button text
            const submitBtn = eventForm.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Event';

            // Go to appropriate page
            if (editingEventId === null) {
                currentPage = getTotalPages();
            }
            
            // Re-render table
            renderEvents();
        });

        // Delete event
        function deleteEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                events = events.filter(event => event.event_id !== id);
                
                // Save to localStorage
                saveEventsToStorage();
                updateStorageStatus();
                
                // Adjust current page if needed
                const totalPages = getTotalPages();
                if (currentPage > totalPages && currentPage > 1) {
                    currentPage = totalPages;
                }
                
                renderEvents();
            }
        }

        // Clear browser storage
        function clearStorage() {
            if (confirm('This will delete all events and settings from browser storage and reload the page with embedded data. Continue?')) {
                localStorage.removeItem('vdem_training_events');
                localStorage.removeItem('vdem_training_settings');
                alert('Browser storage cleared! The page will reload.');
                location.reload();
            }
        }

        // Load from VDEM website
        async function loadFromVDEM() {
            const url = 'https://www.vaemergency.gov/resources/training-schedule1';
            
            try {
                // Try to fetch the page
                const response = await fetch(url, { mode: 'cors' });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch VDEM page');
                }
                
                const html = await response.text();
                
                // Parse HTML to find meta tag
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const metaTag = doc.querySelector('meta[name="type"]');
                
                if (!metaTag) {
                    throw new Error('Meta tag with event data not found on page');
                }
                
                const metaContent = metaTag.getAttribute('content');
                
                // Decode HTML entities
                const textarea = document.createElement('textarea');
                textarea.innerHTML = metaContent;
                let decodedJson = textarea.value;
                
                // Fix malformed JSON (remove extra commas)
                decodedJson = decodedJson
                    .replace(/^\{,\s*/, '{')        // Remove leading comma
                    .replace(/,,\s*/g, ',')          // Replace double commas with single
                    .replace(/,\s*\}/, '}')          // Remove trailing comma before }
                    .replace(/,\s*\]/, ']');         // Remove trailing comma before ]
                
                // Try to parse as single object first
                let importedData;
                try {
                    const singleEvent = JSON.parse(decodedJson);
                    importedData = Array.isArray(singleEvent) ? singleEvent : [singleEvent];
                } catch (e) {
                    throw new Error('Failed to parse event data: ' + e.message);
                }
                
                // Import the data
                processImportedData(importedData);
                
            } catch (error) {
                console.error('VDEM import error:', error);
                
                // Show user-friendly error with workaround
                alert(
                    'Unable to load from VDEM website directly.\n\n' +
                    'Error: ' + error.message + '\n\n' +
                    'WORKAROUND:\n' +
                    '1. Visit: ' + url + '\n' +
                    '2. Right-click → View Page Source\n' +
                    '3. Find the <meta name="type"> tag\n' +
                    '4. Copy the content attribute value\n' +
                    '5. Use "Import Data" to upload it\n\n' +
                    'OR: Use the import-data.json file that came with this app.'
                );
            }
        }

        // Process imported data (shared function)
        function processImportedData(importedData) {
            // Validate it's an array
            if (!Array.isArray(importedData)) {
                alert('Invalid data format. Expected an array of events.');
                return;
            }

            // Ask user if they want to replace or merge
            const hasExistingData = events.length > 0;
            let shouldMerge = false;

            if (hasExistingData) {
                const choice = confirm(
                    'You have ' + events.length + ' existing event(s).\n\n' +
                    'Click OK to MERGE imported data with existing events.\n' +
                    'Click Cancel to REPLACE all existing events.'
                );
                shouldMerge = choice;
            }

            if (shouldMerge) {
                // Merge: add imported events with new IDs
                const maxId = events.length > 0 ? Math.max(...events.map(e => e.event_id)) : 0;
                importedData.forEach((event, index) => {
                    event.event_id = maxId + index + 1;
                    events.push(event);
                });
                alert('Imported ' + importedData.length + ' events. Total events: ' + events.length);
            } else {
                // Replace: use imported data as-is
                events = importedData;
                nextId = events.length > 0 ? Math.max(...events.map(e => e.event_id)) + 1 : 1;
                alert('Replaced all data with ' + importedData.length + ' imported events.');
            }

            // Save to localStorage
            saveEventsToStorage();
            updateStorageStatus();

            // Reset to first page and render
            currentPage = 1;
            renderEvents();
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    processImportedData(importedData);
                    
                    // Clear the file input so the same file can be imported again
                    event.target.value = '';

                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                    console.error('Import error:', error);
                }
            };

            reader.readAsText(file);
        }

        // Export data to modal
        function exportData() {
            const modal = document.getElementById('exportModal');
            const viewer = document.getElementById('jsonViewer');
            viewer.textContent = JSON.stringify(events, null, 2);
            modal.classList.add('show');
        }

        // Close modal
        function closeModal(event) {
            if (!event || event.target === document.getElementById('exportModal')) {
                document.getElementById('exportModal').classList.remove('show');
            }
        }

        // Copy to clipboard
        function copyToClipboard() {
            const text = document.getElementById('jsonViewer').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied to clipboard!');
            });
        }

        // Save to file - generates new HTML with embedded data and settings
        function saveToFile() {
            // Get current HTML
            const html = document.documentElement.outerHTML;
            
            // Replace the embedded data section
            const dataScript = '<script id="embedded-data" type="application/json">\n' + 
                JSON.stringify(events, null, 2) + '\n    <\/script>';
            
            // Replace the embedded settings section
            const settingsScript = '<script id="embedded-settings" type="application/json">\n' + 
                JSON.stringify(settings, null, 2) + '\n    <\/script>';
            
            let updatedHtml = html.replace(
                /<script id="embedded-data" type="application\/json">[\s\S]*?<\/script>/,
                dataScript
            );
            
            updatedHtml = updatedHtml.replace(
                /<script id="embedded-settings" type="application\/json">[\s\S]*?<\/script>/,
                settingsScript
            );
            
            // Create blob and download
            const blob = new Blob([updatedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vdem-training-events.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('File downloaded! Replace the old HTML file with this new one to persist your changes.');
        }

        // Initial render
        loadSettings();
        
        // Auto-load from GitHub Pages if localStorage is empty
        if (events.length === 0) {
            fetchLatestData().then(success => {
                if (!success) {
                    // If fetch failed, just render what we have (empty or embedded)
                    renderEvents();
                }
            });
        } else {
            renderEvents();
        }
    </script>
</body>
</html>